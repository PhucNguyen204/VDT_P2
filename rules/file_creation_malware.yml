title: Malware File Creation Patterns
id: 34567890-3456-3456-3456-345678901abc
description: Detects file creation patterns commonly associated with malware
author: EDR Security Team
date: 2024-01-01
level: high
tags:
  - attack.persistence
  - attack.t1547
  - attack.defense_evasion
  - attack.t1564
logsource:
  category: file_event
  product: windows
detection:
  selection_temp_exe:
    EventID: 11
    TargetFilename|contains: '\Temp\'
    TargetFilename|endswith:
      - '.exe'
      - '.scr'
      - '.bat'
      - '.cmd'
      - '.pif'
  selection_startup_persistence:
    EventID: 11
    TargetFilename|contains:
      - '\Startup\'
      - '\Start Menu\Programs\Startup\'
      - 'Microsoft\Windows\Start Menu\Programs\Startup\'
  selection_system_dirs:
    EventID: 11
    TargetFilename|startswith:
      - 'C:\Windows\System32\'
      - 'C:\Windows\SysWOW64\'
    TargetFilename|endswith:
      - '.exe'
      - '.dll'
    Image|endswith:
      - '\powershell.exe'
      - '\cmd.exe'
      - '\wscript.exe'
      - '\cscript.exe'
      - '\mshta.exe'
  selection_double_extension:
    EventID: 11
    TargetFilename|contains:
      - '.pdf.exe'
      - '.doc.exe'
      - '.txt.exe'
      - '.jpg.exe'
      - '.png.exe'
      - '.zip.exe'
  selection_hidden_files:
    EventID: 11
    TargetFilename|contains: '\AppData\Local\Temp\'
    TargetFilename|endswith:
      - '.tmp'
      - '.dat'
      - '.bin'
    ProcessName|endswith:
      - '\powershell.exe'
      - '\rundll32.exe'
      - '\regsvr32.exe'
  condition: selection_temp_exe or selection_startup_persistence or selection_system_dirs or selection_double_extension or selection_hidden_files
falsepositives:
  - Legitimate software installations
  - Administrative scripts
  - Temporary files from legitimate applications
references:
  - https://attack.mitre.org/techniques/T1547/
  - https://attack.mitre.org/techniques/T1564/
